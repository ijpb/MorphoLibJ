#LyX 2.1 created this file. For more info see http://www.lyx.org/
\lyxformat 474
\begin_document
\begin_header
\textclass scrreprt
\begin_preamble
\usepackage[dvipsnames]{xcolor}

\usepackage{hyperref}
\usepackage{lstlinebgrd}

\definecolor{bl}{rgb}{0.0,0.2,0.6} 

\definecolor{mygreen}{rgb}{0,0.6,0}
\definecolor{mygray}{rgb}{0.5,0.5,0.5}
\definecolor{lightgray}{rgb}{0.95,0.95,0.95}
\definecolor{mymauve}{rgb}{0.58,0,0.82}

\hypersetup{colorlinks=true, citecolor=blue, linkcolor=blue}


% package that modifies style of section headers
\addtokomafont{chapter}{\color{bl}\scshape \selectfont}
\addtokomafont{section}{\color{bl}\scshape \selectfont}
\addtokomafont{subsection}{\color{bl}\scshape \selectfont}
\addtokomafont{subsubsection}{\color{bl}\scshape \selectfont}
%\allsectionsfont{\color{bl}\scshape \selectfont }

% setup font style for different title elements
\setkomafont{title}{\color{bl} \bfseries \scshape}
\setkomafont{author}{\centering \small}
\setkomafont{date}{\centering \small}


% Change the abstract environment
\usepackage[runin]{abstract}			% runin option for a run-in title
\setlength\absleftindent{30pt}		% left margin
\setlength\absrightindent{30pt}		% right margin
\abslabeldelim{\quad }						% 
\setlength{\abstitleskip}{-10pt}
\renewcommand{\abstractname}{}
\renewcommand{\abstracttextfont}{\color{bl} \small \slshape }	% slanted text



% Custom headers and footers
\usepackage{fancyhdr}
% Enabling the custom headers/footers
\pagestyle{fancy}
\usepackage{lastpage}	
% Header (empty)
% Haut a gauche - page g : chapitre (sl), page d : page (bf) - plain : rien
\lhead[\fancyplain{}{\slshape\leftmark}]{\fancyplain{}{}}
% rien au centre
\chead{}
% Haut a droite - page g : page (bf), page d : section (sl) - plain : rien
\rhead[\fancyplain{}{}]{\fancyplain{}{\slshape\rightmark}}

% Footer (you may change this to your own needs)
\lfoot{\footnotesize \jobname.lyx}
\cfoot{}
\rfoot{\footnotesize page \thepage\ / \pageref{LastPage}}	% "Page 1 / 2"
\renewcommand{\headrulewidth}{0.0pt}
\renewcommand{\footrulewidth}{0.4pt}

% chap a gauche sans numero, rien a droite
%\renewcommand{\chaptermark}[1]{\markboth{\textit{#1}}{}}
\renewcommand{\chaptermark}[1]{\markboth{\thechapter\ #1}{}}
% section à droite avec numero
\renewcommand{\sectionmark}[1]{\markright{\thesection\ #1}}
% Added by lyx2lyx
\usepackage[charter]{mathdesign}

% setup of figure captions 
\usepackage[format=plain,font=it,labelfont=bf]{caption}
%\captionsetup[figure]{name=Figure}
%\DeclareCaptionLabelSeparator{colon}{.}
\end_preamble
\use_default_options true
\maintain_unincluded_children false
\language american
\language_package default
\inputencoding auto
\fontencoding global
\font_roman default
\font_sans default
\font_typewriter beramono
\font_math auto
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100
\font_tt_scale 100
\graphics default
\default_output_format pdf2
\output_sync 0
\bibtex_command default
\index_command default
\float_placement h
\paperfontsize default
\spacing single
\use_hyperref true
\pdf_bookmarks true
\pdf_bookmarksnumbered false
\pdf_bookmarksopen false
\pdf_bookmarksopenlevel 1
\pdf_breaklinks false
\pdf_pdfborder false
\pdf_colorlinks false
\pdf_backref false
\pdf_pdfusetitle true
\papersize a4paper
\use_geometry false
\use_package amsmath 1
\use_package amssymb 1
\use_package cancel 1
\use_package esint 1
\use_package mathdots 1
\use_package mathtools 1
\use_package mhchem 1
\use_package stackrel 1
\use_package stmaryrd 1
\use_package undertilde 1
\cite_engine natbib
\cite_engine_type authoryear
\biblio_style plainnat
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\justification true
\use_refstyle 0
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 1
\paragraph_separation indent
\paragraph_indentation default
\quotes_language english
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Standard

\lang french
\begin_inset ERT
status open

\begin_layout Plain Layout


\backslash
lstset{numbers=left, tabsize=2, frame=single, breaklines=true, basicstyle=
\backslash
scriptsize
\backslash
ttfamily, aboveskip=5pt}
\end_layout

\begin_layout Plain Layout


\backslash
lstset{language=java, keywordstyle=
\backslash
bfseries, commentstyle=
\backslash
color{OliveGreen}
\backslash
itshape, stringstyle=
\backslash
color{BrickRed}, showspaces=false}
\end_layout

\end_inset


\end_layout

\begin_layout Title
MorphoLibJ user manual
\end_layout

\begin_layout Author
David Legland, Ignacio Arganda-Carreras
\end_layout

\begin_layout Standard
\begin_inset CommandInset toc
LatexCommand tableofcontents

\end_inset


\end_layout

\begin_layout Abstract
The 
\begin_inset Quotes fld
\end_inset

MorphoLibJ
\begin_inset Quotes frd
\end_inset

 library for ImageJ/Fiji contains a variety of plugins for processing and
 analyzing 2D or 3D images.
 It was originally designed for the study of plant cell images, but the
 algorithms are generic and can be applied to any type of image.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
TODO:
\end_layout

\begin_layout Itemize
finir de rédiger les paragraphes
\end_layout

\begin_layout Itemize
ajouter illustrations 
\end_layout

\begin_layout Itemize
peaufiner vocabulaire : regions / label, component / region...
\end_layout

\begin_layout Itemize
adresses Ignacio+David
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Overview
\end_layout

\begin_layout Standard
The library implements several functionalities that were missing in the
 ImageJ software (
\begin_inset CommandInset citation
LatexCommand citet
key "Schneider_2012_nmeth,Schindelin_2012_nmeth"

\end_inset

), and that were not or only partially covered by other plugins.
 
\end_layout

\begin_layout Itemize

\series bold
morphological filtering
\series default
 for 2D/3D and binary or grayscale images: erosion & dilation, closing &
 opening, morphological gradient & Laplacian, top-hat...
\end_layout

\begin_layout Itemize

\series bold
morphological reconstruction
\series default
, for 2D/3D and binary or grayscale images, allowing fast detection of regional
 or extended extrema, removing of borders, or hole filling
\end_layout

\begin_layout Itemize

\series bold
watershed segmentation
\series default
 + GUI, making it possible to segment 2D/3D images of cell tissues
\end_layout

\begin_layout Itemize

\series bold
2D/3D measurements
\series default
: volume, surface area, inertia ellipse/ellipsoid...
\end_layout

\begin_layout Itemize

\series bold
several utilities
\series default
 for the manipulation of binary and label images
\end_layout

\begin_layout Standard
The home page of the project is located at 
\begin_inset CommandInset href
LatexCommand href
target "http://ijpb.github.io/MorphoLibJ/"

\end_inset

, and the source code can be found on GitHub: 
\begin_inset CommandInset href
LatexCommand href
target "http://github.com/ijpb/MorphoLibJ"

\end_inset

.
 The exhaustive code documentation includes many use-case examples, and
 can be found online
\begin_inset Foot
status open

\begin_layout Plain Layout
\begin_inset Flex URL
status open

\begin_layout Plain Layout

http://ijpb.github.io/MorphoLibJ/javadoc/
\end_layout

\end_inset


\end_layout

\end_inset

.
\end_layout

\begin_layout Chapter
Installation instructions
\end_layout

\begin_layout Section
Installation in ImageJ
\end_layout

\begin_layout Standard
To install the MorphoLibJ toolkit in ImageJ, you only need to download the
 latest release (in the form of a JAR file) into ImageJ's plugins folder
 and restart ImageJ.
 
\end_layout

\begin_layout Standard
All released versions can be found at 
\begin_inset Flex URL
status open

\begin_layout Plain Layout

https://github.com/ijpb/MorphoLibJ/releases
\end_layout

\end_inset

.
 
\end_layout

\begin_layout Section
Installation in Fiji
\end_layout

\begin_layout Standard
If you use Fiji (
\begin_inset CommandInset citation
LatexCommand citet
key "Schindelin_2012_nmeth,Schneider_2012_nmeth"

\end_inset

), the MorphoLibJ toolkit can be easily installed by adding its update site
 to Fiji's list of update sites:
\end_layout

\begin_layout Enumerate
Open Fiji and select 
\emph on
Help > Update...

\emph default
 from the Fiji menu to start the updater.
\begin_inset Newline newline
\end_inset


\begin_inset Graphics
	filename images/Fiji-updater-menu.png
	width 75text%

\end_inset


\begin_inset Newline newline
\end_inset


\begin_inset Newpage pagebreak
\end_inset


\end_layout

\begin_layout Enumerate
When the updater is open, click on 
\emph on
Manage update sites
\emph default
.
\begin_inset Newline newline
\end_inset


\begin_inset Graphics
	filename images/Fiji-updater-GUI.png
	width 75text%

\end_inset


\end_layout

\begin_layout Enumerate
This brings up a dialog where you can activate additional update sites:
\begin_inset Newline newline
\end_inset


\begin_inset Graphics
	filename images/Fiji-updater-sites-manager.png
	width 75text%

\end_inset


\begin_inset Newline newline
\end_inset


\begin_inset Newpage pagebreak
\end_inset


\end_layout

\begin_layout Enumerate
Activate the MorphoLibJ update site and close the dialog.
 Now you should see an additional jar file for download:
\begin_inset Newline newline
\end_inset


\begin_inset Graphics
	filename images/Fiji-updater-MorphoLibJ-jar.png
	width 75text%

\end_inset


\end_layout

\begin_layout Enumerate
Finally, click on 
\emph on
Apply changes
\emph default
 and restart Fiji.
 All the plugins should be available after restarting.
\end_layout

\begin_layout Chapter
Morphological filters
\end_layout

\begin_layout Standard
\begin_inset CommandInset label
LatexCommand label
name "chap:Morphological-Filters"

\end_inset


\end_layout

\begin_layout Standard
Morphological filters are very common filters that can be combined together
 to provide large variety of solutions.
 They are local filters, in the sense they consider the neighborhood of
 each pixel/voxel.
 
\end_layout

\begin_layout Standard
Morphological filters are defined according to a 
\series bold
structuring element
\series default
 of a given size and shape.
 Common structuring element include squares, discrete disks and octogons.
 Linear structuring element of various orientations may also be used to
 assess local orientation of the structures.
\end_layout

\begin_layout Section
Principles
\end_layout

\begin_layout Subsection
Erosion and dilation
\end_layout

\begin_layout Standard
The most basic morphological filters are the 
\series bold
morphological dilation
\series default
 and the 
\series bold
morphological erosion
\series default
.
 The morphological dilation computes for each pixel the maximum within its
 neighborhood (defined by the structuring element), whereas the morphological
 erosion considers the minimum value within the neighborhood (Fig
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Morpho-Dilation-Erosion"

\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-Dilation-Sq2.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-Erosion-Sq2.png
	width 30text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Morpho-Dilation-Erosion"

\end_inset

Some examples of morphological filters on a grayscale image.
 Original image, result of dilation with a square structuring element, and
 result of erosion with the same structuring element.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Applying a  dilation or an erosion changes the size of the structures in
 the image: the grains in the result of the dilated image are larger.
 Morphological erosion can also be used on binary images to help separating
 touching particles.
\end_layout

\begin_layout Subsection
Opening and closing
\end_layout

\begin_layout Standard
Morphological dilation and erosion are often used in combination.
 For example, the result of a dilation followed by an erosion is called
 a 
\series bold
morphological closing
\series default
, and removes dark structures smaller than the structuring element (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Morpho-Opening-Closing"

\end_inset

).
 It can also connect bright structures that were separated by a thin dark
 space.
\end_layout

\begin_layout Standard
In a symmetric way, the result of an erosion followed by a dilation is called
 a 
\series bold
morphological
\series default
 
\series bold
opening
\series default
, and removes bright structures smaller than the structuring element.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-Closing-Sq2.tif
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-Opening-Sq2.tif
	width 30text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Morpho-Opening-Closing"

\end_inset

Some examples of composed morphological filters.
 Morphological closing (left) and morphological opening (right).
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Note that even if opening and closing better preserve the size of the structures
 in the original image, the shape is slightly altered.
 For example, the result of morphological closing on Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Morpho-Opening-Closing"

\end_inset

 creates artificial connections between grains.
 Choosing the best size for the structuring element is often a compromise
 between noise removal and preservation of structure shape.
\end_layout

\begin_layout Subsection
Morphological gradients
\end_layout

\begin_layout Standard
More complicated combinations of elementary operations can be used.
 The 
\series bold
morphological gradient
\series default
, computed as the difference of the result of a morphological dilation with
 the result of a morphological erosions, reveals the 
\series bold
boundaries
\series default
 of the structures within the image (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Morpho-Gradient-TopHat"

\end_inset

).
 
\end_layout

\begin_layout Standard
The 
\series bold
morphological Laplacian
\series default
 is defined as half the sum of a morphological dilation and a morphological
 erosion with the same structuring element, minus the original image.
 It results in enhancing the edges of the image.
 
\end_layout

\begin_layout Subsection
Top-hats
\end_layout

\begin_layout Standard
The 
\series bold
white top-hat 
\series default
first computes a morphological opening (resulting in removing bright structures
 smaller than structuring elements), and removes the result from the original
 image.
 When applied with a large structuring element, the result is an homogenization
 of the background, making bright structures easier to segment.
 
\end_layout

\begin_layout Standard
Similarly, the 
\series bold
dark top-hat
\series default
 can be used to enhance dark structures observed on an non-homogeneous backgroun
d.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-Gradient-Sq2.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-Laplacian-Sq2.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-WhiteTopHat-Sq20.png
	width 30text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Morpho-Gradient-TopHat"

\end_inset

Some examples of composed morphological filters.
 Morphological gradient, morphological Laplacian, morphological white top-hat.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Usage
\end_layout

\begin_layout Standard
The collection of morphological filters is available in the 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ
\begin_inset Quotes erd
\end_inset

 menu.
 Filters are implemented for both 2D and 3D images, and work for binary,
 grayscale or color (RGB) images.
\end_layout

\begin_layout Subsection
Planar images
\end_layout

\begin_layout Standard
Morphological filters for planar images are available 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Morphological filters
\begin_inset Quotes erd
\end_inset

.
 The dialog let the user choose the structuring element shape, radius, and
 eventually preview the result.
 The following list of operations can be chosen:
\end_layout

\begin_layout Description
erosion keeps the minimum value within the neighborhood defined by the structuri
ng element.
\end_layout

\begin_layout Description
dilation keeps the maximum value within the neighborhood defined by the
 structuring element.
\end_layout

\begin_layout Description
closing consists in the succession of a dilation with an erosion.
 Morphological closing makes dark structures smaller than the structuring
 element disappear.
\end_layout

\begin_layout Description
opening consists in the succession of an erosion with a dilation.
 Morphological opening makes bright structures smaller than the structuring
 element disappear.
\end_layout

\begin_layout Description
morphological
\begin_inset space ~
\end_inset

gradient is defined as the difference of a morphological dilation and a
 morphological erosion with the same structuring element, and enhances edges
 of the original images.
\end_layout

\begin_layout Description
morphological
\begin_inset space ~
\end_inset

Laplacian is defined as half the sum of a morphological dilation and a morpholog
ical erosion with the same structuring element, minus the original image,
 and enhances edges of the image.
\end_layout

\begin_layout Description
black
\begin_inset space ~
\end_inset

top-hat consists in subtracting the original image from the result of a
 morphological closing, and results in the enhancement of dark structures
 smaller than structuring element.
\end_layout

\begin_layout Description
white
\begin_inset space ~
\end_inset

top-hat consists in subtracting the result of a morphological opening from
 the original image, and results in the enhancement of bright structures
 smaller than structuring element.
\end_layout

\begin_layout Standard
The following structuring elements can be used for 2D images:
\end_layout

\begin_layout Itemize
disk 
\end_layout

\begin_layout Itemize
square
\end_layout

\begin_layout Itemize
octagon
\end_layout

\begin_layout Itemize
diamond
\end_layout

\begin_layout Itemize
line with angle of 0, 90, 45 or 135 degrees
\end_layout

\begin_layout Subsection
3D images
\end_layout

\begin_layout Standard
Morphological filters for 3D images are available 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Morphological filters (3D)
\begin_inset Quotes erd
\end_inset

.
 The dialog let the user choose the structuring element shape and radius.
 The same list of operations as for planar images is provided.
 Planar structuring elements can be used (the operation is simply repeated
 on each slice), as well as a cubic or spherical structuring element.
 For most structuring elements, the size can be chosen for each direction.
\end_layout

\begin_layout Chapter
Connected components operators
\end_layout

\begin_layout Standard
\begin_inset CommandInset label
LatexCommand label
name "chap:Connected-Operators"

\end_inset


\end_layout

\begin_layout Standard
The 
\begin_inset Quotes eld
\end_inset

classical
\begin_inset Quotes erd
\end_inset

 morphological filters presented in chapter 
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Morphological-Filters"

\end_inset

 transform an input image by using the values of pixels or voxels located
 in a close neighborhood, defined by the structuring element.
 Such filters can be seen as 
\begin_inset Quotes eld
\end_inset

local
\begin_inset Quotes erd
\end_inset

, as the result in a given position do not depend on image values located
 at a sufficient distance.
 
\end_layout

\begin_layout Standard
Connected components operators are more general as they propagate information
 within image based on connectivity between pixels or voxels.
 More details can be found in the review of 
\begin_inset CommandInset citation
LatexCommand citet
key "Breen_1996_cviu"

\end_inset

.
 Connected components operators encompass powerful operators, such as 
\series bold
morphological reconstruction
\series default
 that allows to reconstruct a marker image by constraining it to a mask.
 An extension of morphological reconstruction is the detection of 
\series bold
extended minima and maxima
\series default
, that can be useful as marker detection for segmentation.
 Finally, 
\series bold
attribute opening and filtering
\series default
 algorithms can filter images based on size or range properties, with better
 preservation of edges than classical filtering.
 
\end_layout

\begin_layout Section
Morphological reconstruction
\end_layout

\begin_layout Standard
The morphological reconstruction is at the basis of many useful algorithms,
 such as border removing, hole filling, or detection of regional minima
 or maxima in grayscale images.
\end_layout

\begin_layout Subsection
Principle
\end_layout

\begin_layout Standard
The principle of geodesic reconstruction is to repeat 
\series bold
conditional dilations or erosions
\series default
 until idempotence.
 Conditional dilation is the result of a dilation, combined with a mask
 image using a logical operation.
 Conditional dilations are repeated until no more modification occur (idempotenc
e condition).
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/binary/particles-Markers-ovr.png
	width 3cm

\end_inset


\begin_inset Graphics
	filename images/binary/particles-condDil01-ovr.png
	width 3cm

\end_inset


\begin_inset Graphics
	filename images/binary/particles-condDil02-ovr.png
	width 3cm

\end_inset


\begin_inset Graphics
	filename images/binary/particles-condDil03-ovr.png
	width 3cm

\end_inset


\begin_inset Graphics
	filename images/binary/particles-condDilIdemp-ovr.png
	width 3cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Geodesic-Reconstruction-Principle"

\end_inset

Principle of the geodesic reconstruction algorithm.
 Original image in gray with marker superimposed in black, and result of
 conditional dilations with increasing sizes.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The figure 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Geodesic-Reconstruction-Principle"

\end_inset

 shows several steps of a geodesic reconstruction by dilation on a pair
 of binary images.
 The mask image is shown in gray, and the marker image is shown in black
 on the first image.
 The reconstructed images at each step are shown in black.
 The markers propagates within the mask until they fill the chosen regions.
\end_layout

\begin_layout Subsection
Applications to binary images
\end_layout

\begin_layout Standard
By choosing the marker image, several operations may be automatized.
 For example, computing geodesic reconstruction with image of borders, and
 combining with original image will 
\series bold
remove particles or regions touching the borders
\series default
 (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Geodesic-Reconstruction-Binary"

\end_inset

).
 In a similar way, computing geodesic reconstruction by using the border
 of the complement of the image makes it possible to 
\series bold
fill holes
\series default
 that may appear in particles.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/binary/particles.tif
	width 4cm

\end_inset


\begin_inset Graphics
	filename images/binary/particles-killBorders.png
	width 4cm

\end_inset


\begin_inset Graphics
	filename images/binary/particles-fillHoles.png
	width 4cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Geodesic-Reconstruction-Binary"

\end_inset

Some applications of geodesic reconstruction.
 From left to right: original image, result of kill borders, result of fill
 holes.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Applications to grayscale images
\end_layout

\begin_layout Standard
Geodesic reconstructions can be applied to grayscale images.
 By manually choosing binary markers such that they overlay specific structures,
 and after applying a geodesic reconstruction by dilation, it is possible
 to obtain a grayscale image containing only the chosen structures (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Geodesic-Reconstruction-Grey"

\end_inset

).
 The 
\series bold
border kill 
\series default
operation can also be applied on grayscale images, making possible to rapidly
 remove structures touching the image borders, while keeping the intensity
 information within the structures.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-binary-markers-ovr.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-geodRec-byDilation.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-killBorders.png
	width 30text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Geodesic-Reconstruction-Grey"

\end_inset

Some applications of geodesic reconstruction on grayscale images.
 From left to right: original image with superimposed markers, result of
 geodesic reconstruction by dilation, result of border kill operation.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Usage
\end_layout

\begin_layout Standard
The geodesic reconstruction algorithm is often used within other operators.
 It is however provided as a plugin to allow its inclusion in user-designed
 macros or plugins:
\end_layout

\begin_layout Description
Geodesic
\begin_inset space ~
\end_inset

Reconstruction compute the geodesic reconstruction by erosion or dilation
 using a marker image and a mask image, and a specified connectivity.
 
\end_layout

\begin_layout Description
Geodesic
\begin_inset space ~
\end_inset

Reconstruction
\begin_inset space ~
\end_inset

3D compute the geodesic reconstruction by erosion or dilation on a 3D image.
\end_layout

\begin_layout Standard
The kill borders and fill holes are also provided as plugin.
 Both works for 2D or 3D images of 8, 16 or 32 bits.
\end_layout

\begin_layout Description
Kill
\begin_inset space ~
\end_inset

Borders remove the particles touching the border of a binary or grayscale
 image, in 2D or 3D
\end_layout

\begin_layout Description
Fill
\begin_inset space ~
\end_inset

Holes remove holes inside particles in binary images, or remove dark regions
 surrounded by bright crests in grayscale images.
 Works for both 2D and 3D images.
\end_layout

\begin_layout Section
Regional and extended extrema
\end_layout

\begin_layout Standard

\series bold
Regional minima 
\series default
are defined as connected regions of elements (pixels or voxels) with the
 same value, and whose neighboring elements all have values greater than
 that of the region.
 Similarly, 
\series bold
regional maxima 
\series default
are regions of connected pixels or voxels with same value, whose neighbors
 all have smaller value (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Regional-And-Extended-Maxima"

\end_inset

).
\end_layout

\begin_layout Standard
One problem arising with regional minima or maxima is that they are very
 sensitive to noise.
 It is often more convenient to use so-called extended extrema.
 The principle is to define a tolerance value for filtering the extrema.
 For example, 
\series bold
extended maxima
\series default
 are defined as a connected region containing elements such that the difference
 of the value of each element within the region with the maximal value within
 the region is lower than the tolerance, and such that the neighbors of
 the regions all have values smaller than the maximum within the region
 minus the tolerance.
 This definition allows the identification of larger extrema, that better
 takes into account the noise within the image.
 The 
\series bold
extended minima 
\series default
are defined in a similar way, and are efficiently used as pre-processing
 step for watershed segmentation.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-filtered.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-rmax-ovr.png
	width 30text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-emax10-ovr.png
	width 30text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Regional-And-Extended-Maxima"

\end_inset

Regional and extended maxima on a grayscale image.
 Left: original image.
 Middle: result of regional maxima.
 Right: result of extended maxima.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
Both extended maxima and minima are computed using the geodesic reconstruction
 algorithm.
 More details can be found in the book of 
\begin_inset CommandInset citation
LatexCommand citet
key "Soille_2003"

\end_inset

.
\end_layout

\begin_layout Standard
The following operations are available in the 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Minima and Maxima
\begin_inset Quotes erd
\end_inset

 menu :
\end_layout

\begin_layout Description
Regional
\begin_inset space ~
\end_inset

Min
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Max compute regional minima or extrema in grayscale or binary image, with
 specified connectivity
\end_layout

\begin_layout Description
Regional
\begin_inset space ~
\end_inset

Min
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Max
\begin_inset space ~
\end_inset

3D compute regional minima or extrema in 3D grayscale or binary image, with
 specified connectivity
\end_layout

\begin_layout Description
Extended
\begin_inset space ~
\end_inset

Min
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Max compute extended minima or extrema in grayscale or binary image, with
 specified connectivity
\end_layout

\begin_layout Description
Extended
\begin_inset space ~
\end_inset

Min
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Max
\begin_inset space ~
\end_inset

3D compute extended minima or extrema in 3D grayscale or binary image, with
 specified connectivity
\end_layout

\begin_layout Description
Impose
\begin_inset space ~
\end_inset

Min
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Max impose binary minima or maxima on a grayscale image.
\end_layout

\begin_layout Description
Impose
\begin_inset space ~
\end_inset

Min
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Max
\begin_inset space ~
\end_inset

3D impose binary minima or maxima on a 3D grayscale image.
\end_layout

\begin_layout Section
Attribute filtering
\end_layout

\begin_layout Standard
Attribute filters aim at removing components of an image based on a certain
 size criterion, rather than on intensity.
 The most common and useful criterion is the number of pixels/voxels (i.e.,
 the area or volume).
 For example, a morphological size opening operation with a threshold value
 of 20 will remove all blobs containing fewer than 20 voxels.
 The length of the diagonal of the bounding box can also be of interest
 to discriminate elongated versus round component shapes.
 
\end_layout

\begin_layout Subsection
Application to binary images
\end_layout

\begin_layout Standard
When applied to a binary image, attribute opening consists in identifying
 each connected component, computing the attribute measurement of each component
, and retain only the connected components whose measurement is above a
 specified value (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Area-Opening-Binary"

\end_inset

).
 This kind of processing is often used to clean-up segmentation results.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-binary-crop-ext.png
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-ext.png
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-sizeOpening-ext.png
	width 31text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Area-Opening-Binary"

\end_inset

Example of area opening on a binary image.
 Left: original binary image.
 Middle: identification of connected components.
 Right: only the connected components with a sufficient size (defined by
 the area), have been retained.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Application to grayscale images
\end_layout

\begin_layout Standard
When applied to a grayscale image, attribute opening consists in generating
 a series of binary images by thresholding at each distinct gray level in
 the image.
 The binary attribute opening described above is then applied independently
 to each binary image and the grayscale output is computed as the union
 of the binary results.
 The final output is a grayscale image whose bright structures with the
 attribute below a given value have disappeared.
 A great advantage of this filter is that the contours of the structures
 area better preserved than opening with a structuring element (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Area-Opening-Gray"

\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/leaf/leaf_crop400.tif
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/leaf/leaf_crop400-areaOpen.tif
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/leaf/leaf_crop400-OpeningSq1.tif
	width 31text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Area-Opening-Gray"

\end_inset

Example of area opening on a grayscale image.
 Left: original grayscale image of a leaf (image courtesy of Eric Biot,
 INRA Versailles).
 Middle: grayscale size opening making bright spots disappear.
 Right: comparison with morphological closing with square structuring element
 of radius 1: bright spots are removed, but some veins also disappear.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
As for classical morphological filters, grayscale attribute closing or tophat
 can be defined.
 Grayscale attribute closing consists in removing dark connected components
 whose size is smaller than a specified value.
 White [resp.
 Black] Attribute Top-Hat considers the difference of the attribute opening
 [resp.
 closing] with the original image, and can help identifying bright [resp.
 dark] structures with small size.
\end_layout

\begin_layout Subsection
Usage
\end_layout

\begin_layout Standard
So far, the following attribute filtering plugins are available within MorphoLib
J:
\end_layout

\begin_layout Description
Gray
\begin_inset space ~
\end_inset

Scale
\begin_inset space ~
\end_inset

Attribute
\begin_inset space ~
\end_inset

Filtering opens a dialog to perform between attribute opening, closing,
 and black or white top-hat on a planar (2D) grayscale image.
 Two size criteria can be used: the area (number of pixels), or the diameter
 (length of the diagonal of the bounding box).
\end_layout

\begin_layout Description
Gray
\begin_inset space ~
\end_inset

Scale
\begin_inset space ~
\end_inset

Size
\begin_inset space ~
\end_inset

Opening
\begin_inset space ~
\end_inset

(2D/3D) opens a dialog to perform size opening on a 2D or 3D grayscale image.
 The size criterion is the number of pixels or voxels.
\end_layout

\begin_layout Chapter
Watershed segmentation
\begin_inset CommandInset label
LatexCommand label
name "chap:Watershed-segmentation"

\end_inset


\end_layout

\begin_layout Standard
The 
\series bold
watershed algorithm
\series default
 assimilates the grayscale image to a digital elevation model, and aims
 at detecting the different catchment basins.
 In the grayscale image, the catchment basins correspond to dark regions
 surrounded by bright structures (the 
\begin_inset Quotes eld
\end_inset

crests
\begin_inset Quotes erd
\end_inset

).
 It is a very popular technique specially used to segment touching objects.
 The MorphoLibJ suite contains several implementations of the algorithm,
 described in the following sections.
\end_layout

\begin_layout Section
Classic Watershed plugin
\end_layout

\begin_layout Subsection
Introduction
\end_layout

\begin_layout Standard
Classic Watershed is an ImageJ/Fiji plugin to perform watershed segmentation
 of grayscale 2D/3D images using flooding simulations as described by 
\begin_inset CommandInset citation
LatexCommand citet
key "Soille_1990,Vincent_1991_pami"

\end_inset

.
\end_layout

\begin_layout Standard
The basic idea consists of considering the input image as topographic surface
 and placing a water source in each regional minimum of its relief.
 Next the entire relief is flooded from the sources and dams are placed
 where the different water sources meet.
\end_layout

\begin_layout Standard
All points in the surface at a given minimum constitute the 
\series bold
catchment basin
\series default
 associated with that minimum.
 The 
\series bold
watersheds
\series default
 are the zones dividing adjacent catchment basins.
\end_layout

\begin_layout Standard
The first image points that are reached by water are the points at the lowest
 grayscale value 
\begin_inset Formula $h_{{min}}$
\end_inset

, then all image pixels are progressively reached up to the highest level
 
\begin_inset Formula $h_{{max}}$
\end_inset

 (see Fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Schematic-overview-of-flooding"

\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/watershed-flooding-scheme.svg
	lyxscale 50
	width 40text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Schematic-overview-of-flooding"

\end_inset

Schematic overview of watershed flooding in 1D
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Usage
\end_layout

\begin_layout Standard
The Classic Watershed plugin runs on any grayscale image (8, 16 and 32-bit)
 in 2D and 3D.
 At least one image needs to be open in order for the plugin to run.
 If that's the case, a dialog like the following will pop up: 
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename images/Classic-Watershed-dialog.png
	width 30text%

\end_inset


\end_layout

\begin_layout Standard
Let's have a look at the different parameters:
\end_layout

\begin_layout Itemize
Image parameters: 
\end_layout

\begin_deeper
\begin_layout Itemize

\series bold
Input image
\series default
: grayscale image to flood, usually the gradient of an image.
 
\end_layout

\begin_layout Itemize

\series bold
Mask image
\series default
 (optional): binary image of the same dimensions as the input image which
 can be used to restrict the areas of application of the algorithm.
 Set to "None" to run the method on the whole input image.
\end_layout

\end_deeper
\begin_layout Itemize
Morphological parameters: 
\end_layout

\begin_deeper
\begin_layout Itemize

\series bold
Use diagonal connectivity
\series default
: select to allow the flooding in diagonal directions (8-connectivity in
 2D and 26-connectivity in 3D).
 
\end_layout

\begin_layout Itemize

\series bold
Min h
\series default
: minimum grayscale value to start flooding from (by default, set to the
 minimum value of the image type).
 
\end_layout

\begin_layout Itemize

\series bold
Max h
\series default
: maximum grayscale value to reach with flooding (by default, set to the
 maximum value of the image type).
\end_layout

\end_deeper
\begin_layout Standard
Output: 
\end_layout

\begin_layout Itemize

\series bold
Labeled image
\series default
 containing the resulting catchment basins (with integer values 1, 2, 3...)
 and watershed lines (with 0 value).
\end_layout

\begin_layout Subsection
Over-segmentation
\end_layout

\begin_layout Standard
Normally, Classic Watershed will lead to an over-segmentation of the input
 image, especially for noisy images with many regional minima.
 In that case, it is recommended to either 
\series bold
pre-process the image before
\series default
 running the plugin, 
\series bold
or merge regions based on a similarity criterion afterwards
\series default
.
 Several de-noising methods are available in Fiji/ImageJ, namely: median
 filtering, Gaussian blur, bilateral filtering, etc.
\end_layout

\begin_layout Paragraph

\series bold
Example:
\end_layout

\begin_layout Standard
This short macro runs the plugin twice in the blobs sample, first without
 pre-processing and then after applying a Gaussian blur of radius 3:
\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// load the Blobs sample image
\end_layout

\begin_layout Plain Layout

run("Blobs (25K)"); 
\end_layout

\begin_layout Plain Layout

// invert LUT and pixel values to have dark blobs 
\end_layout

\begin_layout Plain Layout

run("Invert LUT"); 
\end_layout

\begin_layout Plain Layout

run("Invert"); 
\end_layout

\begin_layout Plain Layout

// run plugin on image 
\end_layout

\begin_layout Plain Layout

run("Classic Watershed", "input=blobs mask=None use min=0 max=150"); 
\end_layout

\begin_layout Plain Layout

// apply LUT to facilitate result visualization 
\end_layout

\begin_layout Plain Layout

run("3-3-2 RGB"); 
\end_layout

\begin_layout Plain Layout

// pre-process image with Gaussian blur selectWindow("blobs.gif"); 
\end_layout

\begin_layout Plain Layout

run("Gaussian Blur...", "sigma=3"); 
\end_layout

\begin_layout Plain Layout

rename("blobs-blur.gif"); 
\end_layout

\begin_layout Plain Layout

// apply plugin on pre-processed image 
\end_layout

\begin_layout Plain Layout

run("Classic Watershed","input=blobs-blur mask=None use min=0 max=150");
 
\end_layout

\begin_layout Plain Layout

// apply LUT to facilitate result visualization 
\end_layout

\begin_layout Plain Layout

run("3-3-2 RGB");
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\begin_inset Tabular
<lyxtabular version="3" rows="1" columns="3">
<features rotate="0" tabularvalignment="middle">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<column alignment="center" valignment="top">
<row>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/blobs-blur.png
	width 32text%

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Gaussian-blurred blobs image used as input (radius = 3).
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/blobs-watershed-no-preprocessing.png
	width 32text%

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Watershed segmentation on original image (
\begin_inset Formula $h_{{min}}=0$
\end_inset

, 
\begin_inset Formula $h_{{max}}=150$
\end_inset

).
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Float figure
wide false
sideways false
status collapsed

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/blobs-blur-watershed.png
	width 32text%

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Watershed segmentation on Gaussian-blurred original image (radius = 3, 
\begin_inset Formula $h_{{min}}=0$
\end_inset

, 
\begin_inset Formula $h_{{max}}=150$
\end_inset

).
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Input and result images from the macro example.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Section
Marker-controlled Watershed plugin
\end_layout

\begin_layout Subsection
Introduction
\end_layout

\begin_layout Standard
Marker-controlled Watershed is an ImageJ/Fiji plugin to segment grayscale
 images of any type (8, 16 and 32-bit) in 2D and 3D based on the marker-controll
ed watershed algorithm by 
\begin_inset CommandInset citation
LatexCommand citet
key "Meyer_1990_jvcir"

\end_inset

.
 As the previous method, this algorithm considers the input image as a topograph
ic surface (where higher pixel values mean higher altitude) but it simulates
 its flooding from
\series bold
 specific seed points or markers
\series default
.
 A common choice for the markers are the local minima of the gradient of
 the image, but the method works on any specific marker, either selected
 manually by the user or determined automatically by another algorithm (see
 Fig.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Example-of-marker-controlled-watershed"

\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/arabidopsis-nucleus-segmentation.svg
	width 90text%

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Example-of-marker-controlled-watershed"

\end_inset

Example of marker-controlled watershed segmentation on nucleus of 
\emph on
Arabidopsis thaliana
\emph default
 (image by courtesy of Kaori Sakai and Javier Arpon, INRA-Versailles).
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Usage
\end_layout

\begin_layout Standard
Marker-controlled Watershed needs at least two images to run.
 If that's the case, a dialog like the following will pop up:
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename images/Marker-controlled-Watershed-dialog.png
	width 40text%

\end_inset


\end_layout

\begin_layout Standard
Let's have a look at the different parameters:
\end_layout

\begin_layout Itemize
Image parameters:
\end_layout

\begin_deeper
\begin_layout Itemize
The 
\series bold
Input image
\series default
: a 2D or 3D grayscale image to flood, usually the gradient of an image.
 
\end_layout

\begin_layout Itemize
The 
\series bold
Marker image
\series default
: an image of the same dimensions as the input containing the seed points
 or markers as connected regions of voxels, each of them with a different
 label.
 They correspond usually to the local minima of the input image, but they
 can be set arbitrarily.
 
\end_layout

\end_deeper
\begin_layout Itemize
And it can optionally admit a third image:
\end_layout

\begin_deeper
\begin_layout Itemize
The 
\series bold
Mask image
\series default
: a binary image of the same dimensions as input and marker which can be
 used to restrict the areas of application of the algorithm.
 Set to "None" to run the method on the whole input image.
 
\end_layout

\end_deeper
\begin_layout Itemize
Rest of parameters:
\end_layout

\begin_deeper
\begin_layout Itemize

\series bold
Calculate dams
\series default
: select to enable the calculation of watershed lines.
 Use diagonal connectivity: select to allow the flooding in diagonal directions.
 
\end_layout

\end_deeper
\begin_layout Standard
Output:
\end_layout

\begin_layout Itemize

\series bold
Labeled image
\series default
 containing the catchment basins and (optionally) watershed lines (dams).
\end_layout

\begin_layout Section
Morphological Segmentation plugin
\end_layout

\begin_layout Subsection
Introduction
\end_layout

\begin_layout Standard
Morphological Segmentation is an ImageJ/Fiji plugin that combines morphological
 operations, such as extended minima and morphological gradient, with watershed
 flooding algorithms to segment grayscale images of any type (8, 16 and
 32-bit) in 2D and 3D.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/Morphological-segmentation-front.png
	lyxscale 50
	width 90text%

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Overview of the Morphological Segmentation plugin.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Usage
\end_layout

\begin_layout Standard
Morphological Segmentation runs on any open grayscale image, single 2D image
 or (3D) stack.
 If no image is open when calling the plugin, an Open dialog will pop up.
\end_layout

\begin_layout Standard
The user can pan, zoom in and out, or scroll between slices (if the input
 image is a stack) in the main canvas as if it were any other ImageJ window.
 On the left side of the canvas there are three panels of parameters, one
 for the input image, one with the watershed parameters and one for the
 output options.
 All buttons, checkboxes and input panels contain a short explanation of
 their functionality that is displayed when the cursor lingers over them.
\end_layout

\begin_layout Standard

\series bold
Image pre-processing
\series default
: some pre-processing is included in the plugin to facilitate the segmentation
 task.
 However, other pre-processing may be required depending on the input image.
 It is up to the user to decide what filtering may be most appropriate upstream.
\end_layout

\begin_layout Subsubsection
Input Image panel
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename images/Morphological-segmentation-input-image-panel.png
	width 40text%

\end_inset


\end_layout

\begin_layout Standard
First, you need to indicate the nature of the input image to process.
 This is a 
\series bold
key parameter
\series default
 since the watershed algorithm is expecting an image where the boundaries
 of objects present high intensity values (usually as a result of a gradient
 or edge detection filtering).
 
\end_layout

\begin_layout Standard
You should select:
\end_layout

\begin_layout Itemize

\series bold
Border Image
\series default
: if your input image has highlighted object boundaries.
 
\end_layout

\begin_layout Itemize

\series bold
Object Image
\series default
: if the borders of the objects do not have higher intensity values than
 the rest of voxels in the image.
 
\end_layout

\begin_layout Standard
When selecting “Object Image”, an additional set of options is enabled to
 choose the type of gradient and radius (in pixels) to apply to the input
 image before starting the morphological operations.
 Finally, a checkbox allows displaying the gradient image instead of the
 input image in the main canvas of the plugin (only after running the watershed
 segmentation).
\end_layout

\begin_layout Subsubsection
Watershed Segmentation panel
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename images/Morphological-segmentation-watershed-segmentation-panel.png
	width 40text%

\end_inset


\end_layout

\begin_layout Standard
This panel is reserved to the parameters involved in the segmentation pipeline.
 By default, only the tolerance can be changed.
 Clicking on “Advanced options” enables the rest of options.
\end_layout

\begin_layout Itemize

\series bold
Tolerance
\series default
: dynamic of intensity for the search of regional minima (in the extended-minima
 transform, which is the regional minima of the H-minima transform, value
 of h).
 Increasing the tolerance value reduces the number of segments in the final
 result, while decreasing its value produces more object splits.
 
\series bold
\color red

\begin_inset Newline newline
\end_inset

Note
\series default
\color inherit
: since the tolerance is an intensity parameter, it is sensitive to the
 input image type.
 A tolerance value of 10 is a good starting point for 8-bit images (with
 0-255 intensity range) but it should be drastically increased when using
 image types with larger intensity ranges.
 For example to ~2000 when working on a 16-bit image (intensity values between
 0 and 65535).
\end_layout

\begin_layout Itemize

\series bold
Calculate dams
\series default
: un-check this option to produce segmentations without watershed lines.
 
\end_layout

\begin_layout Itemize

\series bold
Connectivity
\series default
: voxel connectivity (4-8 in 2D, and 6-26 in 3D).
 Selecting non-diagonal connectivity (4 or 6) usually provides more rounded
 objects.
 
\end_layout

\begin_layout Standard
Finally, 
\series bold
click on “Run” to launch the segmentation
\series default
.
\end_layout

\begin_layout Standard
If your segmentation is taking too long or you want 
\series bold
to stop it
\series default
 for any reason, you can do so by clicking on the same button (which should
 read “STOP” during that process).
\end_layout

\begin_layout Subsubsection
Results panel
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename images/Morphological-segmentation-results-panel.png
	width 40text%

\end_inset


\end_layout

\begin_layout Standard
Only enabled after running the segmentation.
 
\end_layout

\begin_layout Itemize

\series bold
Display
\series default
: list of options to display the segmentation results.
 
\end_layout

\begin_deeper
\begin_layout Itemize

\series bold
Overlaid basins
\series default
: colored objects overlaying the input image (with or without dams depending
 on the selected option in the Watershed Segmentation panel).
 
\end_layout

\begin_layout Itemize

\series bold
Overlaid dams
\series default
: overlay the watershed dams in red on top of the input image (only works
 if “Calculate dams” is checked).
 
\end_layout

\begin_layout Itemize

\series bold
Catchment basins
\series default
: colored objects.
 
\end_layout

\begin_layout Itemize

\series bold
Watershed lines
\series default
: binary image showing the watershed lines in black and the objects in white
 (only works if “Calculate dams” is checked).
 
\end_layout

\end_deeper
\begin_layout Itemize

\series bold
Show result overlay
\series default
: toggle result overlay.
 
\end_layout

\begin_layout Itemize

\series bold
Create image button
\series default
: create a new image with the results displayed in the canvas.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/Morphological-segmentation-result-examples.png
	lyxscale 50
	width 100text%

\end_inset


\begin_inset Caption Standard

\begin_layout Plain Layout
Examples of the 4 different display options.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Post-processing panel
\end_layout

\begin_layout Standard
\align center
\begin_inset Graphics
	filename images/Morphological-segmentation-post-processing-panel.png
	width 40text%

\end_inset


\end_layout

\begin_layout Standard
Similarly to the Results panel, this panel only gets enabled after running
 the segmentation pipeline.
\end_layout

\begin_layout Itemize

\series bold
Merge labels
\series default
: merge together labels selected by either the 
\series bold

\begin_inset Quotes eld
\end_inset

freehand
\begin_inset Quotes erd
\end_inset

 selection tool
\series default
 (on a single slice) 
\series bold
or the point tool
\series default
 (on single or multiple slices).
 The zero-value label belongs to the watershed dams, therefore it will ignored
 in case of being selected.
 The first selected label value will be assigned to the rest of selected
 labels, which will share its color.
 
\begin_inset Newline newline
\end_inset


\series bold
\color red
Note
\series default
\color inherit
: to select labels on different slices, use the point selection tool and
 keep the SHIFT key pressed each time you click on a new label.
\end_layout

\begin_layout Itemize

\series bold
Shuffle colors
\series default
: randomly re-assign colors to the labels.
 This is a very handy option whenever two adjacent labels present a similar
 color.
\end_layout

\begin_layout Subsection
Macro language compatibility
\end_layout

\begin_layout Standard
Morphological Segmentation is completely compatible with the popular ImageJ
 macro language
\begin_inset Foot
status open

\begin_layout Plain Layout
\begin_inset Flex URL
status open

\begin_layout Plain Layout

http://imagej.net/developer/macro/macros.html
\end_layout

\end_inset


\end_layout

\end_inset

.
 Each of the buttons in the GUI are macro-recordable and their commands
 can be reproduced later from a simple macro file.
\end_layout

\begin_layout Standard
The complete list of commands is as follows:
\end_layout

\begin_layout Itemize
Start the plugin:
\begin_inset Newline newline
\end_inset


\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

run("Morphological Segmentation");
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Select input image:
\begin_inset Newline newline
\end_inset


\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// select as object image
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setInputImageType", "object");
\end_layout

\begin_layout Plain Layout

// select as border image
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setInputImageType", "border");
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Run segmentation with specific options:
\begin_inset Newline newline
\end_inset


\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.segment","tolerance=10", "calculat
eDams=true","connectivity=6");
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Toggle result overlay:
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.toggleOverlay");
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Set option to display gradient image:
\begin_inset Newline newline
\end_inset


\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setShowGradient", "true");
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Select display format:
\begin_inset Newline newline
\end_inset


\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// Overlaid basins
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setDisplayFormat", "Overlaid
 basins"); 
\end_layout

\begin_layout Plain Layout

// Overlaid dams
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setDisplayFormat", "Overlaid
 dams");
\end_layout

\begin_layout Plain Layout

// Catchment basins
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setDisplayFormat", "Catchment
 basins");
\end_layout

\begin_layout Plain Layout

// Watershed lines 
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setDisplayFormat", "Watershed
 lines");
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
Create new image with the current result:
\begin_inset Newline newline
\end_inset


\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.createResultImage");
\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection*
Complete macro example
\end_layout

\begin_layout Standard
The following macro opens the Blobs sample image, applies the plugin with
 a tolerance value of 32 and displays the result as overlaid dams.
\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// load the Blobs sample image 
\end_layout

\begin_layout Plain Layout

run("Blobs (25K)"); 
\end_layout

\begin_layout Plain Layout

// run the plugin 
\end_layout

\begin_layout Plain Layout

run("Morphological Segmentation"); 
\end_layout

\begin_layout Plain Layout

// wait for the plugin GUI to load 
\end_layout

\begin_layout Plain Layout

wait(1000); 
\end_layout

\begin_layout Plain Layout

// select input image as "object" 
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setInputImageType", "object");
 
\end_layout

\begin_layout Plain Layout

// set gradient radius as 1 
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setGradientRadius", "1");
 
\end_layout

\begin_layout Plain Layout

// run segmentation with tolerance 32, calculating the watershed dams, 
 
\end_layout

\begin_layout Plain Layout

// 4-connectivity  
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.segment", "tolerance=32",
  "calculateDams=true", "connectivity=4"); 
\end_layout

\begin_layout Plain Layout

// display the overlaid dams 
\end_layout

\begin_layout Plain Layout

call("inra.ijpb.plugins.MorphologicalSegmentation.setDisplayFormat", "Overlaid
 dams");
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Measurements
\end_layout

\begin_layout Section
Particle analysis
\end_layout

\begin_layout Standard
MorphoLibJ contains several tools for quantifying the size, the shape, or
 the spatial organization, from 
\series bold
binary or label
\series default
 2D and 3D images.
 The aim is to facilitate the management of label images, contrary to the
 built-in 
\begin_inset Quotes eld
\end_inset

Analyze Particles...
\begin_inset Quotes erd
\end_inset

 function that operates directly on a grayscale image.
 Most MorphoLibJ plugins consider the current image as input, that must
 be either binary (only one region is considered), or label (typically the
 result of a connected components labeling, see section 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Binary-Images"

\end_inset

).
 The output is a results table (ImageJ 
\emph on
ResultsTable
\emph default
) containing one row for each label actually present within the image.
 The spatial calibration of the image is taken into account in all measurements.
\end_layout

\begin_layout Subsection
Particle analysis 2D
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
TODO : refonte des plugins d'analyse ? d'abord présenter les mesures dans
 un cadre général, puis les plugins ?
\end_layout

\end_inset


\end_layout

\begin_layout Standard
The 
\series bold
global geometry
\series default
 of particles in 2D images can be characterized with the Region Morphometry
 plugin (under 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Analyze\SpecialChar \menuseparator
Region Morphometry
\begin_inset Quotes erd
\end_inset

).
 For 2D particles, the area, the perimeter and derived features are implemened.
 The implemented method for perimeter measurement aims at providing a better
 estimate of the perimeter than traditional boundary pixel count.
 The principle is to consider a set of lines with various orientations,
 and to count the number of intersections with the region(s) of interest
 (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Measurements-Principles"

\end_inset

).
 The number of intersections is proportional to the perimeter 
\begin_inset CommandInset citation
LatexCommand citep
key "Legland2007,Ohser2009"

\end_inset

.
 By averaging over all possible directions, the estimate is unbiased.
 Perimeter is usually estimated using either two directions (horizontal
 and vertical), or four directions (by adding the diagonals).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/analysis/crofton-principle-2d.png
	lyxscale 50
	height 4.5cm

\end_inset


\begin_inset Graphics
	filename images/analysis/geodesic-diameter.png
	height 4.5cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Measurements-Principles"

\end_inset

Computation of the perimeter and of geodesic diameter.
 Left: principle of perimeter estimation by counting intersections with
 set of lines.
 Right: illustration of the geodesic diameter measured on a non convex particle.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
The columns of the results table are:
\end_layout

\begin_layout Description
Label the label of the particle measured on the current line (it can be
 different from the row number if some labels do no exist in original image)
\end_layout

\begin_layout Description
Area the number of pixels within each region, multiplied by the area of
 each pixel.
\end_layout

\begin_layout Description
Perimeter an estimate of the perimeter, using Crofton formula
\end_layout

\begin_layout Description
Circularity the normalized ratio of area by the square of the perimeter
 : 
\begin_inset Formula $4\pi\cdot A/p^{2}$
\end_inset

.
 The value should be comprised between 0 (very elongated) and 1 (close to
 circular).
 Values superior to 1 may appear due to discretization effect.
\end_layout

\begin_layout Description
Elongation the normalized ratio of the square of the perimeter by the area
 : 
\begin_inset Formula $p^{2}/\left(4\pi\cdot A\right)$
\end_inset

, corresponding to the inverse of the circularity.
 The values range from 1 (round), and increase with elongation of the particle.
\end_layout

\begin_layout Standard
Other measurements consider the 
\series bold
largest circle that can be inscribed within the particle
\series default
.
 The plugin opens a dialog that allows to choose the label image to characterize
, the choice of the method for computing distance, and eventually the image
 on which overlaid circles can be drawn.
 The output of the plugin includes the following information:
\end_layout

\begin_layout Description
Label the label of the particle measured on the current line 
\end_layout

\begin_layout Description
xi the x-coordinate of the inscribed circle
\end_layout

\begin_layout Description
yi the y-coordinate of the inscribed circle
\end_layout

\begin_layout Description
radius the radius of the inscribed circle
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/analysis/36_manual1-geodiam.png
	lyxscale 75
	width 6cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Geodesic-Diameter"

\end_inset

Computation of the geodesic diameter on a segmented image from the DRIVE
 database 
\begin_inset CommandInset citation
LatexCommand citep
key "Staal_2004_tmi"

\end_inset

.
 Each connected component was associated to a label, then the longest geodesic
 path within each connected component was computed and displayed as red
 overlay.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
For particles with complex shapes, the 
\series bold
geodesic diameter 
\series default
may be of interest.
 It corresponds of the largest geodesic distance between two points within
 a region, the geodesic distance being the length of the shortest path joining
 the two points while staying inside the region 
\begin_inset CommandInset citation
LatexCommand citep
key "Lantuejoul1981"

\end_inset

.
 An example is given on Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Geodesic-Diameter"

\end_inset

.
 The result of the plugin comprises the following features:
\end_layout

\begin_layout Description
Label the label of the particle measured on the current line 
\end_layout

\begin_layout Description
Geod.
\begin_inset space ~
\end_inset

Diam.
 the value of the geodesic diameter
\end_layout

\begin_layout Description
Radius the radius of the largest inscribed circle, which is computed during
 the algorithm
\end_layout

\begin_layout Description
Geod.
\begin_inset space ~
\end_inset

Elong.
 the ratio of geodesic diameter over the diameter of the largest inscribed
 circle.
 The values range from 1 for nearly round particles and increases for elongated
 particles.
\end_layout

\begin_layout Description
xi,
\begin_inset space ~
\end_inset

yi coordinates of the largest inscribed circle
\end_layout

\begin_layout Description
x1,
\begin_inset space ~
\end_inset

y1 coordinates of one of the geodesic extremities of the particle
\end_layout

\begin_layout Description
x2,
\begin_inset space ~
\end_inset

y2 coordinates of another geodesic extremity of the particle 
\end_layout

\begin_layout Subsection
Particle analysis 3D
\end_layout

\begin_layout Standard
These parameters focus on the shape of the region corresponding to each
 particle or label.
 The plugin calculating these measurements is found under 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Analyze\SpecialChar \menuseparator
Particle Analysis 3D
\begin_inset Quotes erd
\end_inset

.
 The results are provided in an ImageJ 
\emph on
ResultsTable
\emph default
, whose name contains the name of the original image.
 
\end_layout

\begin_layout Description
Label the label of the particle measured on the current line (it can be
 different from the row number if some labels do no exist in original image).
\end_layout

\begin_layout Description
Bounding
\begin_inset space ~
\end_inset

box returns the minimal and maximal coordinates in each direction for each
 label.
\end_layout

\begin_layout Description
Volume computes the number of voxels comprising the particle, multiplied
 by the volume of an individual voxel.
\end_layout

\begin_layout Description
Surface
\begin_inset space ~
\end_inset

area the surface area computed using a discretized version of the Crofton
 formula, that computes intersections with line grids of various orientations
 (currently either 3 or 13).
\end_layout

\begin_layout Description
Sphericity
\begin_inset space ~
\end_inset

index defined as 
\begin_inset Formula $36\pi V^{2}/S^{3}$
\end_inset

.
 
\end_layout

\begin_layout Description
Inertia
\begin_inset space ~
\end_inset

ellipse
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

ellipsoid returns the centroid (center of gravity) as well as the size and
 the orientation of the inertia ellipse or ellipsoid of each particle.
 Radii are sorted in decreasing order.
 Angles are given in degrees, and correspond to the azimut (
\begin_inset Quotes eld
\end_inset

yaw
\begin_inset Quotes erd
\end_inset

), the elevation (
\begin_inset Quotes eld
\end_inset

pitch
\begin_inset Quotes erd
\end_inset

), and the roll around the main axis.
\end_layout

\begin_layout Subsection
Intensity measurements
\end_layout

\begin_layout Standard
Other measurements are provided for pairs of grayscale and label 2D or 3D
 images (
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Analyze\SpecialChar \menuseparator
Measure 3D
\begin_inset Quotes erd
\end_inset

).
 The plugin calculates the mean, the standard deviation, the maximum and
 the minimum intensity value of each labeled region in the grayscale image.
 The results are displayed as well in an ImageJ 
\emph on
ResultsTable
\emph default
.
\end_layout

\begin_layout Section
Spatial organization
\end_layout

\begin_layout Standard
The 
\series bold
region adjacency graph 
\series default
plugin gives access to the neighborhood relationship between adjacent regions
 (Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Region-Adjacency-Graph"

\end_inset

).
 This can be particularly informative for exploring collections of cells
 within cellular tissues 
\begin_inset CommandInset citation
LatexCommand citep
key "Florindo_2016_botanique"

\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/analysis/maize-clsm.png
	lyxscale 60
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/analysis/maize-clsm-watDyn10.png
	lyxscale 60
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/analysis/maize-clsm-rag.png
	lyxscale 60
	width 31text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Region-Adjacency-Graph"

\end_inset

Computation of the Region Adjacency Graph on a microscopy image of plant
 tissue.
 Left: original image.
 Middle: result of watershed segmentation.
 Right: overlay of edges representing adjacent regions.
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
The plugin (under 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Analyze\SpecialChar \menuseparator
Region Adjacency Graph
\begin_inset Quotes erd
\end_inset

) works for both 2D and 3D images, and requires a label image as input.
 A typical input is the result of a watershed segmentation (see section
 
\begin_inset CommandInset ref
LatexCommand ref
reference "chap:Watershed-segmentation"

\end_inset

), eventually followed by manual edition of the labels (see section 
\begin_inset CommandInset ref
LatexCommand ref
reference "sec:Label-Edition-plugin"

\end_inset

).
 The output of the plugin is a results table with as many rows as the number
 of pairs of adjacent regions, containing the labels of the two adjacent
 regions.
\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Section
Microstructure analysis
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status open

\begin_layout Plain Layout
Think about incorporating gray level granulometries
\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Binary and label image utilities
\end_layout

\begin_layout Standard
The MorphoLibJ library provides several utility functions for processing
 binary and label images.
\end_layout

\begin_layout Section
Utilities for binary images
\end_layout

\begin_layout Standard
\begin_inset CommandInset label
LatexCommand label
name "sec:Binary-Images"

\end_inset

Some functions specific for the processing of binary images.
 The plugins can be found in the 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Binary
\begin_inset Quotes erd
\end_inset

 menu.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-binary-crop-ext.png
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-ext.png
	width 31text%

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-inv-dist-ext.png
	width 31text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Binary image, result of connected components labeling, and computation of
 distance map on the complement of binary image.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Description
Connected
\begin_inset space ~
\end_inset

Components
\begin_inset space ~
\end_inset

Labeling transforms the binary image into a label image by assigning a specific
 number (label) to each connected component
\end_layout

\begin_layout Description
Chamfer
\begin_inset space ~
\end_inset

Distance
\begin_inset space ~
\end_inset

Map computes an approximate distance from a binary image map between each
 foreground pixel to the nearest background pixel
\end_layout

\begin_layout Description
Chamfer
\begin_inset space ~
\end_inset

Distance
\begin_inset space ~
\end_inset

Map
\begin_inset space ~
\end_inset

3D computes an approximate distance map from a 3D binary image between each
 foreground voxel to the nearest background voxel
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/binary/36_manual1-ovr.png
	lyxscale 50
	width 5cm

\end_inset

 
\begin_inset Graphics
	filename images/binary/36_manual1-geoddist-rgb.png
	lyxscale 50
	width 5cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "fig:Geodesic-Distance-Map"

\end_inset

Computation of the geodesic distance map on a binary image from the DRIVE
 database 
\begin_inset CommandInset citation
LatexCommand citep
key "Staal_2004_tmi"

\end_inset

.
 Left: original image with marker superimposed in red.
 Right: result of geodesic distance map, hot colors correspond to large
 distances, cold colors correspond to small distances.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Description
Geodesic
\begin_inset space ~
\end_inset

Distance
\begin_inset space ~
\end_inset

Map computes the geodesic distance between each foreground pixel of a binary
 mask image to the closest pixel of a marker image, while staying within
 the particle represented by the mask image (See Figure
\begin_inset space ~
\end_inset


\begin_inset CommandInset ref
LatexCommand ref
reference "fig:Geodesic-Distance-Map"

\end_inset

).
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-binary-crop-ext.png
	width 3.5cm

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-largest-ext.png
	width 3.5cm

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-killLargest-ext.png
	width 3.5cm

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-areaOpen-ext.png
	width 3.5cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Utilities for binary images.
 From left to right: original image, keep largest region, remove largest
 region, apply size opening for keeping only regions with at least 150 pixels.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Description
Keep
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Remove
\begin_inset space ~
\end_inset

Largest
\begin_inset space ~
\end_inset

Region identifies the largest connected component, and keep it or remove
 it
\end_layout

\begin_layout Description
Size
\begin_inset space ~
\end_inset

Opening computes the size (area in 2D, volume in 3D) of each connected component
, and remove all particles whose size is below the value specified by the
 user.
\end_layout

\begin_layout Standard
Algorithms work for both 2D or 3D images.
 Default connectivity 4 (resp.
 6) is used for 2D (resp.
 3D) images.
\end_layout

\begin_layout Section
Utilities for label images
\end_layout

\begin_layout Standard
\begin_inset CommandInset label
LatexCommand label
name "sec:Label-Images"

\end_inset


\end_layout

\begin_layout Standard
Some functions are specific for the processing of label images, in which
 the pixel/voxel value is used to identify the particle it belongs to.
 The value 0 is assumed to correspond to the background.
 The number of labels that can be represented depends on the image type:
 255 for byte images, 65535 for short images...
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-ext.png
	width 3.5cm

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-killBorders-ext.png
	width 3.5cm

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-killLargest-ext.png
	width 3.5cm

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-sizeOpening-ext.png
	width 3.5cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Utilities for label images.
 From left to right: original label image, remove border labels, remove
 largest region, apply size opening for keeping only regions with at least
 150 pixels.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Description
Remove
\begin_inset space ~
\end_inset

Border
\begin_inset space ~
\end_inset

Labels similar to 
\begin_inset Quotes eld
\end_inset

kill borders
\begin_inset Quotes erd
\end_inset

 function, but operates faster as no morphological reconstruction is required.
\end_layout

\begin_layout Description
Select
\begin_inset space ~
\end_inset

Label(s) enters a set of labels, and creates a new label image containing
 only the selected labels.
\end_layout

\begin_layout Description
Crop
\begin_inset space ~
\end_inset

Label creates a new binary image containing only the label specified by
 the user.
 The size of the new image is fitted to the region.
\end_layout

\begin_layout Description
Replace
\begin_inset space ~
\end_inset

Value replaces the value of a region by another value.
 Can be used to 
\begin_inset Quotes eld
\end_inset

clear
\begin_inset Quotes erd
\end_inset

 a label, by replacing its value by 0, or to merge to adjacent regions,
 by replacing the value of a label by the value of its neighbor.
\end_layout

\begin_layout Description
Label
\begin_inset space ~
\end_inset

Boundaries creates a new binary image containing value 255 for pixels/voxels
 having a neighbor with a different value.
\end_layout

\begin_layout Description
Keep
\begin_inset space ~
\end_inset

/
\begin_inset space ~
\end_inset

Remove
\begin_inset space ~
\end_inset

Largest
\begin_inset space ~
\end_inset

Label identifies the largest label, and keep it or remove it
\end_layout

\begin_layout Description
Label
\begin_inset space ~
\end_inset

Size
\begin_inset space ~
\end_inset

Opening computes the size (area in 2D, volume in 3D) of each region, and
 remove all labels whose size is below the value specified by the user.
\end_layout

\begin_layout Description
Assign
\begin_inset space ~
\end_inset

Measure
\begin_inset space ~
\end_inset

To
\begin_inset space ~
\end_inset

Label combines a label image with a results table, and creates a new image
 for which each pixel/voxel is assigned the measurement value corresponding
 to the label it belongs to.
\end_layout

\begin_layout Description
Set
\begin_inset space ~
\end_inset

Label
\begin_inset space ~
\end_inset

Map allows to choose the color map used to display a label image.
 In particular, shuffling the color map and/or choosing a specific color
 for background allows better visualization than with only gray levels.
\end_layout

\begin_layout Description
Label
\begin_inset space ~
\end_inset

To
\begin_inset space ~
\end_inset

RGB converts a label image to true RGB image.
 Similar to ImageJ native conversion, but this plugin avoids confusion between
 background pixels and labels with small values.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/grains/grains-binary-crop-lbl-ext.png
	width 4cm

\end_inset

 
\begin_inset Graphics
	filename images/grains/grains-binary-crop-1-lbl-Elong.png
	width 4cm

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Assign result of a measurement to a label image.
 In this example, the elongation is represented using a color code, between
 dark purple (circular) to yellow (very elongated).
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Section
Label Edition plugin
\begin_inset CommandInset label
LatexCommand label
name "sec:Label-Edition-plugin"

\end_inset


\end_layout

\begin_layout Standard
To ease the processing of label images, MorphoLibJ provides the Label Edition
 plugin (available under 
\begin_inset Quotes eld
\end_inset

Plugins\SpecialChar \menuseparator
MorphoLibJ\SpecialChar \menuseparator
Labels\SpecialChar \menuseparator
Label Edition
\begin_inset Quotes erd
\end_inset

).
 This plugin contains a graphical user interface (GUI) where the users can
 perform the following set of editing tasks:
\end_layout

\begin_layout Itemize
Manually merge labels after their selection using the point selection tool
 (in 2D and 3D).
\end_layout

\begin_layout Itemize
Apply morphological erosion, dilation, opening and closing with a square/cube
 of radius 1 as structuring element.
\end_layout

\begin_layout Itemize
Remove labels by area or volume (size opening operation), largest size,
 manual selection or border location.
\end_layout

\begin_layout Standard
All operations are performed 
\begin_inset Quotes eld
\end_inset

in place
\begin_inset Quotes erd
\end_inset

, i.e., the input image gets directly modified.
 However, the initial status of the label image can be recovered by clicking
 on 
\begin_inset Quotes eld
\end_inset

Reset
\begin_inset Quotes erd
\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/Label-Edition-plugin.png
	width 100text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
Label Edition plugin.
 From left to right and from top to bottom: overview of the plugin GUI on
 a 2D label image, result of label merging by manual selection, removal
 of selected labels, label erosion and removal of largest label.
 
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Chapter
Library interoperability
\end_layout

\begin_layout Standard
A key design concept was the modularity of the implementation to facilitate
 its reusability.
 Three layers with different programming abstraction can be identified:
\end_layout

\begin_layout Itemize
For final users, plugins provide graphical display and intuitive tuning
 of parameters.
 Such plugins can easily be incorporated into a macro:
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// Calls the Regional Min/Max plugin on current ImagePlus instance
\end_layout

\begin_layout Plain Layout

run("Regional Min & Max", "operation=[Regional Maxima] connectivity=4");
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
For plugins developers, operators are available through collections of static
 methods, making it possible to apply most operations with a single line
 of code.
 Example:
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// Computes regional maxima using the 4-connectivity
\end_layout

\begin_layout Plain Layout

ImageProcessor maxima = MinimaAndMaxima.regionalMaxima(image, 4);
\end_layout

\end_inset


\end_layout

\begin_layout Itemize
For core developers, algorithms are implementations of abstract interfaces,
 making it possible to choose or develop the most appropriate one, and to
 monitor execution events.
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// choose and setup the appropriate algorithm
\end_layout

\begin_layout Plain Layout

RegionalExtremaAlgo algo = new RegionalExtremaByFlooding(); 
\end_layout

\begin_layout Plain Layout

algo.setExtremaType(ExtremaType.MAXIMA);
\end_layout

\begin_layout Plain Layout

algo.setConnectivity(4);
\end_layout

\begin_layout Plain Layout

// add algorithm monitoring
\end_layout

\begin_layout Plain Layout

algo.addAlgoListener(new DefaultAlgoListener());
\end_layout

\begin_layout Plain Layout

// compute result on a given ImageProcessor
\end_layout

\begin_layout Plain Layout

ImageProcessor result = algo.applyTo(image);
\end_layout

\end_inset


\end_layout

\begin_layout Standard
In total, the library provides nearly two hundred classes and interfaces
\begin_inset Note Note
status open

\begin_layout Plain Layout
, for around 37000 lines of code
\end_layout

\end_inset

.
 
\end_layout

\begin_layout Section
Library organization
\end_layout

\begin_layout Standard
The library follows a logic structure of folders divided by topics aiming
 at their re-usability from other plugins or scripts, among others:
\end_layout

\begin_layout Description
inra.ijpb.data contains generic data structures for manipulating 2D or 3D
 images
\end_layout

\begin_layout Description
inra.ijpb.binary contains the set of utilities for working on binary images
 (connected component labeling, distance transform, geodesic distance transform...)
\end_layout

\begin_layout Description
inra.ijpb.label contains the utilities for label images (cropping, size opening,
 remove border labels, etc)
\end_layout

\begin_layout Description
inra.ijpb.measure contains the tools for geometric and gray level characterization
 of 2D or 3D images
\end_layout

\begin_layout Description
inra.ijpb.morphology contains the collection of mathematical morphology operators
\end_layout

\begin_layout Description
inra.ijpb.watershed contains the classes implementing the different versions
 of the watershed algorithm
\end_layout

\begin_layout Description
inra.ijpb.plugins contains the set of plugins that is accessible from ImageJ/Fiji
 Plugins menu
\end_layout

\begin_layout Standard
All major methods have a general class with static methods that allow calling
 the methods on 2D and 3D images in a transparent way.
 This modularity permitted to develop other plugins devoted to the analysis
 of nucleus images
\begin_inset CommandInset citation
LatexCommand citep
key "Poulet_2015_bmc"

\end_inset

, gray level granulometries 
\begin_inset CommandInset citation
LatexCommand citep
key "Devaux2014"

\end_inset

 or the description of binary microstructures 
\begin_inset CommandInset citation
LatexCommand citep
key "Silva2015"

\end_inset

.
\end_layout

\begin_layout Section
Scripting MorphoLibJ 
\end_layout

\begin_layout Standard
One advantage of this organization of the library and the use of public
 static methods is that it allows very easy and fast prototyping of morphologica
l algorithms and pipelines.
 
\end_layout

\begin_layout Subsection
Segmentation pipeline prototype
\end_layout

\begin_layout Standard
Let's see an example in a complete Beanshell script that takes the active
 2D or 3D image and finds a reasonable segmentation combining a set of morpholog
ical operations (gradient, extended minima and watershed):
\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// @ImagePlus imp
\end_layout

\begin_layout Plain Layout

 
\end_layout

\begin_layout Plain Layout

// ImageJ imports
\end_layout

\begin_layout Plain Layout

import ij.IJ;
\end_layout

\begin_layout Plain Layout

import ij.ImagePlus;
\end_layout

\begin_layout Plain Layout

import ij.ImageStack;
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

// MorphoLibJ imports
\end_layout

\begin_layout Plain Layout

import inra.ijpb.binary.BinaryImages;
\end_layout

\begin_layout Plain Layout

import inra.ijpb.morphology.MinimaAndMaxima3D;
\end_layout

\begin_layout Plain Layout

import inra.ijpb.morphology.Morphology;
\end_layout

\begin_layout Plain Layout

import inra.ijpb.morphology.Strel3D;
\end_layout

\begin_layout Plain Layout

import inra.ijpb.watershed.Watershed;
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

// create structuring element (cube of radius 1)
\end_layout

\begin_layout Plain Layout

strel = Strel3D.Shape.CUBE.fromRadius( 1 );
\end_layout

\begin_layout Plain Layout

// apply morphological gradient to input image
\end_layout

\begin_layout Plain Layout

image = Morphology.gradient( imp.getImageStack(), strel );
\end_layout

\begin_layout Plain Layout

// find regional minima on gradient image with dynamic value of 30 and 6-connect
ivity
\end_layout

\begin_layout Plain Layout

regionalMinima = MinimaAndMaxima3D.extendedMinima( image, 30, 6 );
\end_layout

\begin_layout Plain Layout

// impose minima on gradient image
\end_layout

\begin_layout Plain Layout

imposedMinima = MinimaAndMaxima3D.imposeMinima( image, regionalMinima, 6
 );
\end_layout

\begin_layout Plain Layout

// label minima using connected components (32-bit output)
\end_layout

\begin_layout Plain Layout

labeledMinima = BinaryImages.componentsLabeling( regionalMinima, 6, 32 );
\end_layout

\begin_layout Plain Layout

// apply marker-based watershed using the labeled minima on the minima-imposed
 
\end_layout

\begin_layout Plain Layout

// gradient image (the "true" value indicates the use of dams in the output)
\end_layout

\begin_layout Plain Layout

resultStack = Watershed.computeWatershed( imposedMinima, labeledMinima, 6,
 true );
\end_layout

\begin_layout Plain Layout

  
\end_layout

\begin_layout Plain Layout

// create image with watershed result
\end_layout

\begin_layout Plain Layout

resultImage = new ImagePlus( "watershed", resultStack );
\end_layout

\begin_layout Plain Layout

// assign right calibration
\end_layout

\begin_layout Plain Layout

resultImage.setCalibration( imp.getCalibration() );
\end_layout

\begin_layout Plain Layout

// and show it
\end_layout

\begin_layout Plain Layout

resultImage.show();
\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Label visualization in 3D viewer
\end_layout

\begin_layout Standard
Making use of MorphoLibJ's label methods and the ImageJ 3D Viewer's visualizatio
n tools it is quite simple to create a script to display each label of an
 image as 3D surfaces of the corresponding colors provided by the image
 look-up table:
\end_layout

\begin_layout Standard

\end_layout

\begin_layout Standard
\begin_inset listings
lstparams "basicstyle={\scriptsize},breaklines=true,captionpos=b,commentstyle={\color{mygreen}},keywordstyle={\color{blue}},language=Java,linebackgroundcolor={\ifodd\value{lstnumber}\color{lightgray}\fi},numbers=left,showstringspaces=false,stringstyle={\color{magenta}}"
inline false
status open

\begin_layout Plain Layout

// @ImagePlus imp   
\end_layout

\begin_layout Plain Layout

import inra.ijpb.label.LabelImages; 
\end_layout

\begin_layout Plain Layout

import ij3d.Image3DUniverse; 
\end_layout

\begin_layout Plain Layout

import ij3d.ContentConstants; 
\end_layout

\begin_layout Plain Layout

import org.scijava.vecmath.Color3f; 
\end_layout

\begin_layout Plain Layout

import ij.IJ; 
\end_layout

\begin_layout Plain Layout

import isosurface.SmoothControl;   
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

// set to true to display messages in log window 
\end_layout

\begin_layout Plain Layout

verbose = false;   
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

// set display range to 0-255 so the displayed colors 
\end_layout

\begin_layout Plain Layout

// correspond to the LUT values 
\end_layout

\begin_layout Plain Layout

imp.setDisplayRange( 0, 255 ); imp.updateAndDraw();   
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

// calculate array of all labels in image 
\end_layout

\begin_layout Plain Layout

labels = LabelImages.findAllLabels( imp );   
\end_layout

\begin_layout Plain Layout

// create 3d universe univ = new Image3DUniverse(); 
\end_layout

\begin_layout Plain Layout

univ.show();   
\end_layout

\begin_layout Plain Layout

// read LUT from input image lut = imp.getLuts()[0];   
\end_layout

\begin_layout Plain Layout

// add all labels different from zero (background) 
\end_layout

\begin_layout Plain Layout

// to 3d universe 
\end_layout

\begin_layout Plain Layout

for( i=0; i<labels.length; i++ ) 
\end_layout

\begin_layout Plain Layout

{        
\end_layout

\begin_layout Plain Layout

	if( labels[ i ] > 0 )     
\end_layout

\begin_layout Plain Layout

	{         
\end_layout

\begin_layout Plain Layout

		labelToKeep = new int[ 1 ];         
\end_layout

\begin_layout Plain Layout

		labelToKeep[ 0 ] = labels[ i ];         
\end_layout

\begin_layout Plain Layout

		if( verbose )             
\end_layout

\begin_layout Plain Layout

		IJ.log( "Reconstructing label " + labels[ i ] + "..." );         
\end_layout

\begin_layout Plain Layout

		
\end_layout

\begin_layout Plain Layout

		// create new image containing only that label         
\end_layout

\begin_layout Plain Layout

		labelImp = LabelImages.keepLabels( imp, labelToKeep );         
\end_layout

\begin_layout Plain Layout

		// convert image to 8-bit         
\end_layout

\begin_layout Plain Layout

		IJ.run( labelImp, "8-bit", "" );                   
\end_layout

\begin_layout Plain Layout

		// use LUT label color         
\end_layout

\begin_layout Plain Layout

		color = new Color3f( new java.awt.Color( lut.getRed( labels[ i ] ),     
        
\end_layout

\begin_layout Plain Layout

							lut.getGreen( labels[ i ] ),             
\end_layout

\begin_layout Plain Layout

							lut.getBlue( labels[ i ] ) ) );                       
\end_layout

\begin_layout Plain Layout

		if ( verbose )             
\end_layout

\begin_layout Plain Layout

			IJ.log( "RGB( " + lut.getRed( labels[ i ] ) +", "
\end_layout

\begin_layout Plain Layout

							+ lut.getGreen( labels[ i ] )                 
\end_layout

\begin_layout Plain Layout

							+ ", " + lut.getBlue( labels[ i ] ) + ")" );           
\end_layout

\begin_layout Plain Layout

		channels = new boolean[3];         
\end_layout

\begin_layout Plain Layout

		channels[ 0 ] = false;         
\end_layout

\begin_layout Plain Layout

		channels[ 1 ] = false;         
\end_layout

\begin_layout Plain Layout

		channels[ 2 ] = false;                   
\end_layout

\begin_layout Plain Layout

		// add label image with corresponding color as an isosurface         
\end_layout

\begin_layout Plain Layout

		univ.addContent( labelImp, color, "label-"+labels[i], 0, channels, 2, ContentCo
nstants.SURFACE);     
\end_layout

\begin_layout Plain Layout

	} 
\end_layout

\begin_layout Plain Layout

}   
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

// launch smooth control 
\end_layout

\begin_layout Plain Layout

sc = new SmoothControl( univ );
\end_layout

\end_inset


\end_layout

\begin_layout Standard
At the end of the script a dialog is shown to smooth the surfaces at will.
 Each label is added to the 3D scene independently with the name "label-X"
 where X is its label value.
 
\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\align center
\begin_inset Graphics
	filename images/MorphoLibJ-visualize-labels-in-3d-viewer.png
	lyxscale 25
	width 100text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption Standard

\begin_layout Plain Layout
From left to right: input label image, script output, smoothed label surfaces
 and example of individually translated surfaces in the 3D viewer.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Note Note
status collapsed

\begin_layout Chapter
Applications
\end_layout

\begin_layout Section
Segmentation and analysis of Arabidospis early embryo
\end_layout

\begin_layout Plain Layout
[morphological filtering : directional ?]
\end_layout

\begin_layout Plain Layout
[detection of minima by extended min]
\end_layout

\begin_layout Plain Layout
[watershed -> set of labels]
\end_layout

\begin_layout Plain Layout
[manual edition of labels]
\end_layout

\begin_layout Plain Layout
[morphometry of individual particles]
\end_layout

\begin_layout Plain Layout
[create 3D result image of parametric mapping]
\end_layout

\begin_layout Section
Analysis of hemp fibre morphology
\end_layout

\begin_layout Plain Layout
[geodesic diameter, tortuosity of particles]
\end_layout

\begin_layout Section
Characterization of dairy matrix microstructure
\end_layout

\begin_layout Plain Layout
[computation of tortuosity for binary microstructure, granulometry, area
 and boundary length densities]
\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset CommandInset bibtex
LatexCommand bibtex
bibfiles "bibliography"
options "bibtotoc,apalike2"

\end_inset


\end_layout

\end_body
\end_document
